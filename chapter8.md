# 第 8 章：采样、切片与粒子化——把“真实”变成“可写作素材”

## 8.1 开篇：为什么不仅要合成，还要采样？

在前几章中，我们使用振荡器（Synth）从零开始构建声音。这很像用数学公式画画，线条干净、纯粹，但往往缺乏“尘土味”和“现实感”。

对于本书设定的目标风格，**采样（Sampling）** 是不可或缺的灵魂：
*   **华语古风/戏腔**：你需要真实的琵琶轮指、古琴手指滑过琴弦的摩擦声，或者是你自己录的一句“咿呀”戏腔。这些声音中包含了复杂的非线性振动，合成器极难模拟。
*   **Hans Zimmer 风格**：那些巨大的太鼓（Taiko）、充满空气感的铜管冲击（Braams），通常是高品质的采样库与合成器的叠加。你需要的是那种“录音棚里的空气震动感”。
*   **人声处理**：人声是最复杂的乐器。Sonic Pi 很难“合成”出逼真的人声，但它可以极其灵活地**重组、扭曲、重塑**现有的人声录音。

本章的目标不是让你仅仅“播放”一个 MP3 文件，而是学会**像捏橡皮泥一样**改变采样的时间、音高、质感和颗粒，将其变成你代码中的一部分。

---

## 8.2 核心逻辑：播放器与磁带机思维

在 Sonic Pi 中使用 `sample` 命令时，请彻底抛弃“媒体播放器”的概念，想象你面前有一台**可物理变速的磁带机**。

### 1. 速率（Rate）：音高与时间的硬耦合
这是与现代 DAW（数字音频工作站）最不同的地方，也是声音设计的物理基础。
在 Sonic Pi 的默认采样引擎中：
$$ \text{播放时长} = \frac{\text{原始时长}}{|\text{rate}|} $$

*   **播放速度加倍 (`rate: 2`)** $\rightarrow$ **音高升高八度** $\rightarrow$ **时间缩短一半**。
*   **播放速度减半 (`rate: 0.5`)** $\rightarrow$ **音高降低八度** $\rightarrow$ **时间延长一倍**。
*   **倒放 (`rate: -1`)** $\rightarrow$ 音高不变，时间倒流。

> **Rule of Thumb（风格化建议）：**
> *   **Zimmer 式恐怖氛围**：将普通的“金属敲击”或“小提琴拨奏”采样，设置 `rate: 0.125`（慢 8 倍，低 3 个八度）。你会听到原本听不见的高频瞬态变成了深沉、隆隆作响的巨大怪兽脚步声。
> *   **古风空灵感**：将钢琴或风铃采样设为 `rate: -1`（倒放）。倒放的声音没有明显的“敲击头（Attack）”，只有慢慢涌现的音量，非常适合做 Pad（铺底）。

### 2. 振幅包络（Envelope）依然有效
即使是录好的音频，也可以被“雕刻”。`sample` 命令同样支持 ADSR（Attack, Decay, Sustain, Release）包络。

```text
原始采样波形:  |########################| (长达 10 秒)
                ↓ 设置 release: 0.1
实际听感:      |#| (变成了短促的 0.1 秒打击声)
```

这允许你把长段的古琴独奏采样，修剪成极短的、带有木质感的打击乐颗粒。

---

## 8.3 时间伸缩：`beat_stretch` 的魔法

**痛点**：你下载了一个 100 BPM 的“史诗战鼓”循环，但你的项目速度是 `use_bpm 120`。如果直接播放，鼓点会和你的代码虽然对不上拍，导致“跑马”。

**解决方案**：`beat_stretch`。
这个参数告诉 Sonic Pi：“不管这个音频原本多长（几秒或几毫秒），请通过改变播放速度，强行把它拉伸/压缩到 X 拍的长度。”

### ASCII 示意图：对齐网格

```text
[你的代码节拍] :  | 1 beat | 1 beat | 1 beat | 1 beat |
[原始音频采样] :  |----- 1.3 秒 (不尴不尬的长度) ------|
                      ↓ beat_stretch: 4
[处理后的采样] :  |---------- 刚好填满 4 拍 -----------|
```

> **注意**：`beat_stretch` 会导致音高变化（像磁带加速一样）。如果你需要保持音高不变但改变速度（Time Stretching without Pitch Shift），Sonic Pi 的基础 `sample` 命令做不到这一点（需要复杂的颗粒合成算法），但在打击乐上，音高的小幅变化通常可以接受。

---

## 8.4 切片（Slicing）：把“一句”变成“颗粒”

这是**人声处理**和**现代古风节奏**的核心技巧。Sonic Pi 提供了两种强大的切片方式。

### 方式 A：均匀切片 (`num_slices`)
适用于**节奏规整**的素材（如鼓组 Loop）。
假设你有一个 4 拍的鼓组，你想把它打散重组。

*   `num_slices: 16`：把采样平均切成 16 份。
*   `slice: 3`：只播放第 4 份（索引从 0 开始）。

**应用场景：IDM / Glitch 风格节奏**
在 Hans Zimmer 的动作场景配乐中，经常会有极高频的、破碎的电子节奏作为背景驱动。你可以把一个普通的鼓组切成 16 份，然后用 `pick` 随机选择切片播放，形成一种“高科技、不稳定”的律动。

### 方式 B：瞬态检测 (`onsets`) —— 戏腔的救星
适用于**节奏自由、不规整**的素材（如人声清唱、独奏乐器）。
戏腔通常是“散板”，没有固定的 BPM。如果你用均匀切片，可能会把一个字切成两半。
`onset` 算法会自动分析波形的能量峰值（即声音开始的地方），按“发音点”来切。

```text
波形:   [ 我... ] [ 身... ]   [ 骑... ] [ 白... ] [ 马... ]
         ↑ onset:0 ↑ onset:1   ↑ onset:2
```

**应用场景：Vocal Chops（人声切片乐器）**
1.  载入一句戏腔长音。
2.  使用 `onset: pick` 随机选取一个字。
3.  加上混响。
4.  这会产生一种既有人声质感，又像电子乐器的现代背景声，是当下“国潮”电子音乐的标志性手法。

---

## 8.5 粒子合成（Granular Synthesis）：创造材质

除了切分明显的段落，我们还可以进入微观界。
**粒子合成**是指播放采样中极其微小（比如 0.05 秒到 0.2 秒）的片段，并大量重复或叠加。这能把一段“具体的旋律”变成一团“抽象的材质”。

### 实现原理：微观指针移动

你需要控制两个核心参数：
1.  **`start`**: 播放起点的百分比（0.0 到 1.0）。
2.  **`finish`**: 播放终点的百分比。

**公式：** `finish = start + 极小值`

### 常见粒子化手法

#### 1. 材质云（Texture Cloud）—— 古风氛围
*   **素材**：一段古筝刮奏或笛子长音。
*   **做法**：在 `live_loop` 中极快地（例如每 0.05 秒）触发采样。
*   **参数**：每次触发时，`start` 设为随机值，包络极短（attack/release 0.01），左右声道随机平移（pan）。
*   **听感**：你听不出原来的旋律，只听到一阵带有“竹子味”或“丝弦味”的迷雾。这是制作独特 Pad 的最佳方法。

#### 2. 时间冻结（Time Freezing）—— 悬疑时刻
*   **素材**一段人声。
*   **做法**：快速循环触发。
*   **参数**：`start` 固定在某个点（例如 0.5），`finish` 设为 0.505。
*   **听感**：这就像时间卡住了，声音会变成一个持续的机械音色，音色特征取决于卡住的那个瞬间是元音“a”还是辅音“s”。

---

## 8.6 采样分层（Layering）与动态

在管弦乐配乐中，**力度（Velocity）** 不仅仅是音量大小，还意味着音色的改变。
*   **弱击**：声音闷、暗、圆润。
*   **强击**：声音亮、炸裂、泛音丰富。

如果你只有一个采样文件（One-shot），仅仅改变 `amp`（音量）是不够真实的。

### Rule of Thumb：低通滤波器模拟力度
在 Sonic Pi 中，我们可以用滤波器（LPF）来模拟这种物理特性。

$$ \text{Cutoff Frequency} \propto \text{Amplitude} $$

*   **逻辑**：当你要播放一个“弱”的音时，不仅要把 `amp` 调小，还要把 `lpf`（低通截止频率）调低，切掉高频。
*   **代直觉**：`sample :drum_snare_hard, amp: 0.5, lpf: 80`。
*   **效果**：这会让同一个采样听起来既可以像“轻触”，也可以像“重击”，大大增加了动态表现力，这对模拟 Zimmer 式的打击乐组至关重要。

---

## 8.7 素材管理：文件命名与工程结构

当你开始大量使用外部采样时，代码很快会变乱。

1.  **路径管理**：
    建议在你的 Sonic Pi 脚本头部定义一个变量指向你的采样文件夹：
    `root = "/Users/YourName/Music/SonicPiProject/Samples/"`
    然后调用时：`sample root, "gu_zheng_01"`。

2.  **格式支持**：
    Sonic Pi 完美支持 **WAV** (16/24 bit) 和 **FLAC**。尽量避免使用 MP3，因为 MP3 在做循环（looping）时首尾会有极短的静音，导致节奏对不齐。

3.  **单声道 vs 立体声**：
    *   **Kick/Bass/Snare**：通常使用单声道（Mono）采样，或者强制转为单声道，保证低频有力且在正中间。
    *   **Pad/Atmosphere/Strings**：用立体声（Stereo）采样，保留空间感。

---

## 8.8 本章小结

1.  **磁带机模型**：`rate` 同时改变速度和音高。负数 `rate` 是倒放，是制作氛围的神器。
2.  **网格对齐**：使用 `beat_stretch` 强行让 Loop 类采样适应你的 BPM，防止“跑马”。
3.  **切片（Slicing）**：
    *   `num_slices`：适合切分机械节奏。
    *   `onset`：适合切分人声、独奏乐器等自然素材。
4.  **微观粒子**：随机起点 + 极短包络 = 材质云（Texture Cloud）。
5.  **滤波器联动**：用 `lpf` 随 `amp` 变化来模拟真实乐器的力度响应。

---

## 8.9 练习题

### 基础题（熟悉参数）

**练习 1：变速变调实验**
找一个说话的人声采样（Sonic Pi 自带或你自己的）。
1.  让它以正常速度播放。
2.  让它像“花栗鼠”一样播放（高八度）。
3.  让它像“巨灵神”一样播放（低八度）。
4.  让它倒着说“外星语”。
*提示：关注 `rate` 参数的值（1, 2, 0.5, -1）。*

**练习 2：强制对齐**
找一个明显的鼓组 Loop（Sonic Pi 自带 `loop_amen` 或 `loop_garzul`）。
1.  设置全局 BPM 为 100。
2.  让这个 Loop 严格占据 4 拍的时间长度，无论它原本多快。
*提示：使用 `beat_stretch` 参数。*

**练习 3：简单的切片重组**
使用 `loop_amen`。
1.  将其切成 8 份。
2.  在一个 `live_loop` 中，每隔 0.5 拍播放这个 Loop 的**第 4 片**（slice index 3）。
3.  听听看这变成了什么样的节奏？

### 挑战题（进阶应用）

**挑战 1：手动制作“古风颗粒云”（Gufeng Drone）**
选择一个具有长延音的吉他或古琴采样。编写一个循环，每隔 0.125 拍播放一次该采样。
要求：
*   每次播放的起点（start）是 0 到 0.8 之间的随机数。
*   每次播放的长度极短（finish = start + 0.05）。
*   音量随机波动。
*   左右声道位置（pan）随机。
*   **目标**：创造出一种连绵不断的、闪烁的景音墙，听不出原本的旋律。

**挑战 2：人声切片乐器（Vocal Chops）**
录制或选取一段长人声（最好是清唱）。
编写代码，通过随机数触发人声的不同**瞬态（onset）**。
要求：
*   不要用 `num_slices`，用 `onset: pick`。
*   给切片加上混响（Reverb）和回声（Echo）。
*   尝试改变 `rate` 使其产生和声效果（例如有的切片 `rate: 1`，有的 `rate: 1.5` 即纯五度）。
*   **思考**：如何让人声听起来不像“人”，而像一种“合成器”？

---

### 参考答案与提示（已折叠）

<details>
<summary>点击展开：练习题提示与思路</summary>

**练习 1 思路：**
*   正常：`rate: 1`
*   花栗鼠：`rate: 2`
*   巨灵神：`rate: 0.5`
*   倒放：`rate: -1`
*   *进阶提示：尝试 `rate: 1.056` (半音) 微调音高。*

**练习 2 思路：**
*   关键在于 `sample :loop_amen, beat_stretch: 4`。
*   别忘了在 `live_loop` 中配合 `sleep 4` 来匹配循环长度，否采样会重叠得很乱。

**练习 3 思路：**
*   参数组合：`num_slices: 8`, `slice: 3`。
*   这会只播放鼓组中的某一个军鼓或镲片声，创造出一种重复的机械感。

**挑战 1（颗粒云）思路：**
*   需要在 `live_loop` 内部计算变量。
*   `s = rand` (0 到 0.8 的随机数)
*   `f = s + 0.05` (结束点只比起点晚一点点)
*   `sample ..., start: s, finish: f, attack: 0.01, release: 0.05, pan: rrand(-1, 1)`
*   这种高密度的触发需要注意 CPU 使用率，如果卡顿，适当增加 `sleep` 时间或减少效果器层数。

**挑战 2（Vocal Chops）思路：**
*   `onset: pick` 是自动随机选一个音节，非常方便。
*   和声技巧：`rate: 1.5` 对应纯五度（大约），`rate: 1.25` 对应大三度（大约）。
*   效果链：`with_fx :reverb, room: 0.8 do ... end` 包裹你的切片逻辑。
*   这会把人声变成类似 Kygo 或 DJ Snake 歌曲中的那种 lead synth。

</details>

---

## 8.10 常见陷阱 (Gotchas)

1.  **爆音与点击声（Clicking）**：
    *   **现象**：当你不使用 ADSR 包络直接播放采样的片段（特别是使用 `start`/`finish` 切割时），声音开头或结尾可能会有“咔”的一声。
    *   **原因**：波形被强行在非零电压位置（Non-zero crossing）切断，导致扬声器纸盆瞬间跳变。
    *   **解决**：永远给切片加上微小的 `attack: 0.01` 和 `release: 0.01`，即使原本不需要渐入渐出。这叫“去点击（De-clicking）”。

2.  **找不到文件（File Not Found）**：
    *   **现象**：Sonic Pi 报错说找不到外部 WAV/FLAC 文件。
    *   **解决**：
        *   路径中尽量不要包含中文字符。
        *   Windows 用户注意反斜杠 `\` 需写成双反斜杠 `\\` 或单斜杠 `/`。
        *   **最强技巧**：直接把采样文件从文件夹拖进 Sonic Pi 的代码编辑框，它会自动生成正确的路径字符串。

3.  **内存爆炸（RAM Spike）**：
    *   **现象**：载了一个 50MB 的管弦乐采样后，电脑卡死或 Sonic Pi 崩溃。
    *   **原因**：Sonic Pi 默认将采样加载到内存中。
    *   **解决**：Sonic Pi 不太适合像 Kontakt 那样加载几 GB 的采样库。对于特别大的文件（如几分钟的背景录音），考虑在 DAW 中剪辑好，只导出你需要的那几秒片段作为新文件。

4.  **节奏对不齐（Drifting）**：
    *   **现象**：用了 `beat_stretch` 还是觉得不稳，听起来像是在拖拍。
    *   **原因**：`beat_stretch` 假设你的采样文件被剪裁得**非常完美**（首尾正好是循环点）。如果你的采样文件开头有 0.2 秒的空白静音，`beat_stretch` 会把这段静音也算进 4 拍里，导致真正的鼓声滞后。
    *   **解决**：在音频编辑软件（如 Audacity / RX）里把采样首尾的空白切得干干净净（Trim Silence）。
